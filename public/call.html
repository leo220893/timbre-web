<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Modo Visitante</title>
  <style>
    body{margin:0;font-family:Arial,Helvetica,sans-serif;background:#e8f1ff;display:flex;flex-direction:column;align-items:center}
    header{background:#1f3a8a;color:#fff;width:100%;text-align:center;padding:14px 10px;font-weight:700;font-size:18px}
    #status{margin:14px 12px;font-size:16px;font-weight:700;color:#1f3a8a;text-align:center}
    .wrap{width:95%;max-width:520px;display:flex;flex-direction:column;gap:10px}
    video{width:100%;border-radius:12px;background:#000;min-height:180px}
    .row{display:flex;gap:10px;flex-wrap:wrap}
    button{flex:1;min-width:140px;padding:12px 16px;border:0;border-radius:10px;font-size:16px;background:#1f3a8a;color:#fff;font-weight:700}
    button.danger{background:#b91c1c}
    button:disabled{opacity:.55}
  </style>
</head>
<body>
  <header>ðŸšª Timbre Digital - Visitante</header>
  <div id="status">Listo para llamar</div>

  <div class="wrap">
    <video id="localVideo" autoplay playsinline muted></video>
    <video id="remoteVideo" autoplay playsinline></video>

    <div class="row">
      <button id="btnLlamar">Llamar</button>
      <button id="btnColgar" class="danger" style="display:none;">Colgar</button>
    </div>
  </div>

<script>
(() => {
  const params = new URLSearchParams(location.search);
  const roomId = params.get("room") || "FLIA.VEGA-BALDOVINO";

  const statusEl = document.getElementById("status");
  const btnLlamar = document.getElementById("btnLlamar");
  const btnColgar = document.getElementById("btnColgar");
  const localVideo = document.getElementById("localVideo");
  const remoteVideo = document.getElementById("remoteVideo");

  let ws;
  let pc = null;
  let localStream = null;
  let calling = false;

  function setStatus(t){ statusEl.textContent = t; }

  function wsUrl(){
    const proto = location.protocol === "https:" ? "wss:" : "ws:";
    return `${proto}//${location.host}`;
  }

  function send(obj){
    if (ws && ws.readyState === WebSocket.OPEN) ws.send(JSON.stringify(obj));
  }

  async function ensureMedia(){
    if (localStream) return localStream;
    localStream = await navigator.mediaDevices.getUserMedia({ video:true, audio:true });
    localVideo.srcObject = localStream;
    return localStream;
  }

  function createPc(){
    pc = new RTCPeerConnection();
    pc.onicecandidate = (e) => {
      if (e.candidate) send({ type:"candidate", candidate:e.candidate });
    };
    pc.ontrack = (e) => {
      remoteVideo.srcObject = e.streams[0];
    };
    return pc;
  }

  async function llamar(){
    try{
      btnLlamar.disabled = true;
      calling = true;

      await ensureMedia();
      createPc();
      localStream.getTracks().forEach(t => pc.addTrack(t, localStream));

      // Aviso de timbre
      send({ type:"ring" });

      const offer = await pc.createOffer();
      await pc.setLocalDescription(offer);
      send({ type:"offer", offer });

      setStatus("ðŸ“ž Llamandoâ€¦");
      btnColgar.style.display = "inline-block";
      btnLlamar.style.display = "none";
    } catch(err){
      console.error(err);
      setStatus("ERROR: could not start audio source (revisÃ¡ permisos / micrÃ³fono).");
      btnLlamar.disabled = false;
      calling = false;
    }
  }

  function colgar(){
    try{ send({ type:"hangup" }); } catch(e){}
    endCallLocal();
  }

  function endCallLocal(){
    try{ if (pc) pc.close(); } catch(e){}
    pc = null;

    try{
      if (localStream){
        localStream.getTracks().forEach(t => t.stop());
      }
    } catch(e){}
    localStream = null;

    localVideo.srcObject = null;
    remoteVideo.srcObject = null;

    setStatus("Listo para llamar");
    btnColgar.style.display = "none";
    btnLlamar.style.display = "inline-block";
    btnLlamar.disabled = false;
    calling = false;
  }

  btnLlamar.addEventListener("click", llamar);
  btnColgar.addEventListener("click", colgar);

  function connect(){
    ws = new WebSocket(wsUrl());

    ws.onopen = () => {
      send({ type:"join", roomId, role:"caller" });
      setStatus("Listo para llamar");
    };

    ws.onmessage = async (ev) => {
      let msg;
      try{ msg = JSON.parse(ev.data); } catch { return; }

      if (msg.type === "answer" && pc){
        await pc.setRemoteDescription(new RTCSessionDescription(msg.answer));
        setStatus("ðŸŽ¥ Llamada en curso");
        return;
      }

      if (msg.type === "candidate" && pc){
        try{ await pc.addIceCandidate(msg.candidate); } catch(e){}
        return;
      }

      if (msg.type === "hangup" || msg.type === "peer-left"){
        endCallLocal();
      }
    };

    ws.onclose = () => {
      if (calling) setStatus("Desconectado. Reintentandoâ€¦");
      setTimeout(connect, 1200);
    };

    ws.onerror = () => {
      try{ ws.close(); } catch(e){}
    };
  }

  connect();
})();
</script>
</body>
</html>