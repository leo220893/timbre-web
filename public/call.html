<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Timbre - Llamar</title>
  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
      margin: 16px;
    }
    #status {
      padding: 10px;
      background: #eef2ff;
      border-radius: 8px;
      margin-bottom: 12px;
    }
    button {
      padding: 14px 18px;
      font-size: 16px;
      border-radius: 10px;
      border: none;
      margin-right: 8px;
      cursor: pointer;
    }
    video {
      width: 100%;
      max-width: 360px;
      background: black;
      border-radius: 12px;
      margin-top: 10px;
    }
  </style>
</head>
<body>

  <h2>ðŸ”” Timbre</h2>
  <div id="status">Estado: esperandoâ€¦</div>

  <button id="callBtn">ðŸ“ž Llamar</button>
  <button id="hangBtn" disabled>â›” Cancelar</button>

  <h4>Tu cÃ¡mara</h4>
  <video id="localVideo" autoplay muted playsinline></video>

  <h4>Domicilio</h4>
  <video id="remoteVideo" autoplay playsinline></video>

<script>
  const roomId =
    new URLSearchParams(window.location.search).get("room") ||
    "FLIA.VEGA-BALDOVINO";

  const statusEl = document.getElementById("status");
  const callBtn = document.getElementById("callBtn");
  const hangBtn = document.getElementById("hangBtn");
  const localVideo = document.getElementById("localVideo");
  const remoteVideo = document.getElementById("remoteVideo");

  let pc = null;
  let localStream = null;

  const wsProtocol = location.protocol === "https:" ? "wss://" : "ws://";
  const ws = new WebSocket(wsProtocol + location.host);

  ws.onopen = () => {
    ws.send(JSON.stringify({ type: "join", roomId, role: "caller" }));
    statusEl.textContent = "Estado: listo para llamar";
  };

  ws.onerror = () => {
    statusEl.textContent = "ERROR: no se pudo conectar";
  };

  ws.onmessage = async (event) => {
    const msg = JSON.parse(event.data);

    if (msg.type === "answer" && pc) {
      await pc.setRemoteDescription(msg.answer);
      statusEl.textContent = "Estado: en llamada";
      return;
    }

    if (msg.type === "candidate" && pc) {
      try { await pc.addIceCandidate(msg.candidate); } catch {}
      return;
    }

    if (msg.type === "hangup" || msg.type === "peer-left") {
      endCall("Llamada finalizada");
      return;
    }
  };

  async function startCall() {
    try {
      callBtn.disabled = true;
      hangBtn.disabled = false;
      statusEl.textContent = "Estado: llamandoâ€¦";

      localStream = await navigator.mediaDevices.getUserMedia({
        video: true,
        audio: true
      });

      localVideo.srcObject = localStream;

      pc = new RTCPeerConnection({
        iceServers: [{ urls: "stun:stun.l.google.com:19302" }]
      });

      localStream.getTracks().forEach(track =>
        pc.addTrack(track, localStream)
      );

      pc.ontrack = (event) => {
        remoteVideo.srcObject = event.streams[0];
      };

      pc.onicecandidate = (event) => {
        if (event.candidate) {
          ws.send(JSON.stringify({
            type: "candidate",
            candidate: event.candidate
          }));
        }
      };

      const offer = await pc.createOffer();
      await pc.setLocalDescription(offer);

      ws.send(JSON.stringify({ type: "offer", offer }));
    } catch (err) {
      statusEl.textContent = "ERROR: " + err.message;
      callBtn.disabled = false;
      hangBtn.disabled = true;
    }
  }

  function endCall(message) {
    statusEl.textContent = "Estado: " + (message || "cancelada");
    callBtn.disabled = false;
    hangBtn.disabled = true;

    if (pc) {
      pc.close();
      pc = null;
    }

    if (localStream) {
      localStream.getTracks().forEach(t => t.stop());
      localStream = null;
    }

    localVideo.srcObject = null;
    remoteVideo.srcObject = null;
  }

  callBtn.addEventListener("click", startCall);
  hangBtn.addEventListener("click", () => {
    ws.send(JSON.stringify({ type: "hangup" }));
    endCall("cancelada");
  });
</script>

</body>
</html>
