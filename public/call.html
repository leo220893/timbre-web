<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Modo Visitante</title>
<style>
  body{margin:0;font-family:Arial,sans-serif;background:#e8f1ff;display:flex;flex-direction:column;align-items:center}
  header{background:#1f3a8a;color:#fff;width:100%;text-align:center;padding:15px;font-weight:700;font-size:18px}
  #status{margin:15px;font-size:16px;font-weight:700;color:#1f3a8a;text-align:center}
  video{width:95%;max-width:520px;border-radius:12px;background:#000;margin:6px 0}
  .row{display:flex;gap:10px;flex-wrap:wrap;justify-content:center;margin:10px}
  button{padding:12px 20px;border:none;border-radius:10px;font-size:16px;background:#1f3a8a;color:#fff}
  button.danger{background:#b91c1c}
</style>
</head>
<body>
<header>ðŸšª Timbre Digital - Visitante</header>

<div id="status">Listo para llamar</div>

<video id="localVideo" autoplay playsinline muted></video>
<video id="remoteVideo" autoplay playsinline></video>

<div class="row">
  <button id="btnLlamar">Llamar</button>
  <button id="btnColgar" class="danger" style="display:none;">Colgar</button>
</div>

<script>
const params = new URLSearchParams(location.search);
const room = params.get("room") || "FLIA.VEGA-BALDOVINO";

const statusEl = document.getElementById("status");
const btnLlamar = document.getElementById("btnLlamar");
const btnColgar = document.getElementById("btnColgar");
const localVideo = document.getElementById("localVideo");
const remoteVideo = document.getElementById("remoteVideo");

let ws;
let localStream = null;
let pc = null;

function setStatus(t){ statusEl.textContent = t; }

function wsUrl() {
  const proto = location.protocol === "https:" ? "wss" : "ws";
  return `${proto}://${location.host}`;
}

function connectWS(){
  ws = new WebSocket(wsUrl());

  ws.onopen = () => {
    ws.send(JSON.stringify({ type:"join", room, role:"visitor" }));
  };

  ws.onmessage = async (ev) => {
    let msg;
    try { msg = JSON.parse(ev.data); } catch { return; }

    if (msg.type === "answer") {
      if (pc && msg.sdp) {
        await pc.setRemoteDescription(msg.sdp);
      }
      return;
    }

    if (msg.type === "candidate") {
      if (pc && msg.candidate) {
        try { await pc.addIceCandidate(msg.candidate); } catch {}
      }
      return;
    }

    if (msg.type === "hangup") {
      endCall();
      return;
    }
  };

  ws.onclose = () => setTimeout(connectWS, 800);
}

async function initMediaVisitor() {
  localStream = await navigator.mediaDevices.getUserMedia({ video:true, audio:true });
  localVideo.srcObject = localStream;
}

function buildPC() {
  pc = new RTCPeerConnection({
    iceServers: [{ urls: "stun:stun.l.google.com:19302" }]
  });

  pc.onicecandidate = (e) => {
    if (e.candidate && ws && ws.readyState === 1) {
      ws.send(JSON.stringify({ type:"candidate", candidate: e.candidate }));
    }
  };

  pc.ontrack = (e) => {
    remoteVideo.srcObject = e.streams[0];
  };

  localStream.getTracks().forEach(t => pc.addTrack(t, localStream));
}

async function startCall() {
  btnLlamar.disabled = true;

  try {
    // 1) avisar ring al owner
    if (ws && ws.readyState === 1) ws.send(JSON.stringify({ type:"ring" }));

    // 2) iniciar webRTC y mandar offer
    await initMediaVisitor();
    buildPC();

    const offer = await pc.createOffer();
    await pc.setLocalDescription(offer);

    ws.send(JSON.stringify({ type:"offer", sdp: pc.localDescription }));

    setStatus("ðŸ“¡ Llamandoâ€¦ esperando que atiendan");
    btnColgar.style.display = "inline-block";
    btnLlamar.style.display = "none";
  } catch (e) {
    console.error(e);
    setStatus("âŒ ERROR: could not start audio source / permisos");
    btnLlamar.disabled = false;
  }
}

function endCall() {
  try { if (pc) pc.close(); } catch {}
  pc = null;

  try {
    if (localStream) localStream.getTracks().forEach(t => t.stop());
  } catch {}
  localStream = null;

  localVideo.srcObject = null;
  remoteVideo.srcObject = null;

  btnColgar.style.display = "none";
  btnLlamar.style.display = "inline-block";
  btnLlamar.disabled = false;

  setStatus("Listo para llamar");
}

btnLlamar.addEventListener("click", startCall);

btnColgar.addEventListener("click", () => {
  if (ws && ws.readyState === 1) ws.send(JSON.stringify({ type:"hangup" }));
  endCall();
});

connectWS();
</script>
</body>
</html>