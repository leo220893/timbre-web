<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Timbre - Propietario</title>
  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
      margin: 16px;
    }
    video {
      width: 100%;
      max-width: 360px;
      background: #000;
      border-radius: 12px;
      margin-top: 10px;
    }
    #status {
      display: inline-block;
      padding: 8px 12px;
      background: #eee;
      border-radius: 999px;
      margin-bottom: 10px;
    }
    button {
      padding: 12px 16px;
      font-size: 15px;
      border-radius: 10px;
      border: none;
      cursor: pointer;
      margin-right: 8px;
      margin-top: 6px;
    }
  </style>
</head>
<body>

  <h2>üè† Propietario</h2>
  <div id="status">Conectando‚Ä¶</div><br>

  <button id="answerBtn" disabled>‚úÖ Atender</button>
  <button id="hangBtn" disabled>‚õî Finalizar</button>
  <button id="notifyBtn">üîî Activar notificaciones</button>

  <h4>Tu c√°mara</h4>
  <video id="localVideo" autoplay muted playsinline></video>

  <h4>Visitante</h4>
  <video id="remoteVideo" autoplay playsinline></video>

<script>
  const roomId =
    new URLSearchParams(window.location.search).get("room") ||
    "FLIA.VEGA-BALDOVINO";

  const statusEl = document.getElementById("status");
  const answerBtn = document.getElementById("answerBtn");
  const hangBtn = document.getElementById("hangBtn");
  const notifyBtn = document.getElementById("notifyBtn");
  const localVideo = document.getElementById("localVideo");
  const remoteVideo = document.getElementById("remoteVideo");

  let pc = null;
  let localStream = null;
  let pendingOffer = null;
  let ringing = false;

  const wsProtocol = location.protocol === "https:" ? "wss://" : "ws://";
  const ws = new WebSocket(wsProtocol + location.host);

  /* =======================
     SONIDO TIMBRE (ding-dong)
     ======================= */
  function dingDong() {
    if (ringing) return;
    ringing = true;

    try {
      const AudioCtx = window.AudioContext || window.webkitAudioContext;
      const ctx = new AudioCtx();
      const now = ctx.currentTime;

      function beep(freq, start, dur) {
        const osc = ctx.createOscillator();
        const gain = ctx.createGain();
        osc.type = "sine";
        osc.frequency.value = freq;
        gain.gain.setValueAtTime(0.0001, start);
        gain.gain.exponentialRampToValueAtTime(0.3, start + 0.01);
        gain.gain.exponentialRampToValueAtTime(0.0001, start + dur);
        osc.connect(gain);
        gain.connect(ctx.destination);
        osc.start(start);
        osc.stop(start + dur);
      }

      beep(880, now + 0.00, 0.18); // ding
      beep(587, now + 0.22, 0.22); // dong

      setTimeout(() => {
        ctx.close().catch(() => {});
        ringing = false;
      }, 700);
    } catch {
      ringing = false;
    }
  }

  /* =======================
     NOTIFICACI√ìN NAVEGADOR
     ======================= */
  function tryNotify() {
    if (!("Notification" in window)) return;
    if (Notification.permission === "granted") {
      new Notification("Timbre", {
        body: "¬°Alguien est√° tocando el timbre en casa!"
      });
    }
  }

  notifyBtn.addEventListener("click", async () => {
    if (!("Notification" in window)) {
      alert("Tu navegador no soporta notificaciones.");
      return;
    }
    const perm = await Notification.requestPermission();
    if (perm === "granted") {
      alert("Notificaciones activadas.");
      tryNotify();
    } else {
      alert("Notificaciones no permitidas.");
    }
  });

  /* =======================
     WEBSOCKET
     ======================= */
  ws.onopen = () => {
    ws.send(JSON.stringify({ type: "join", roomId, role: "owner" }));
    statusEl.textContent = "Esperando‚Ä¶";
  };

  ws.onerror = () => {
    statusEl.textContent = "ERROR: no conecta al servidor";
  };

  ws.onmessage = async (event) => {
    const msg = JSON.parse(event.data);

    if (msg.type === "peer-joined") {
      statusEl.textContent = "Alguien est√° tocando el timbre‚Ä¶";
      dingDong();
      tryNotify();
      return;
    }

    // ‚ö†Ô∏è NO atiende autom√°ticamente
    if (msg.type === "offer") {
      pendingOffer = msg.offer;
      statusEl.textContent = "Llamada entrante";
      answerBtn.disabled = false;
      dingDong();
      tryNotify();
      return;
    }

    if (msg.type === "candidate" && pc) {
      try { await pc.addIceCandidate(msg.candidate); } catch {}
    }

    if (msg.type === "hangup" || msg.type === "peer-left") {
      endCall();
    }
  };

  /* =======================
     ATENDER
     ======================= */
  answerBtn.addEventListener("click", async () => {
    if (!pendingOffer) return;

    answerBtn.disabled = true;
    statusEl.textContent = "Conectando‚Ä¶";

    await ensurePeer();
    await pc.setRemoteDescription(pendingOffer);

    const answer = await pc.createAnswer();
    await pc.setLocalDescription(answer);

    ws.send(JSON.stringify({ type: "answer", answer }));

    pendingOffer = null;
    statusEl.textContent = "En llamada";
    hangBtn.disabled = false;
  });

  /* =======================
     FINALIZAR
     ======================= */
  hangBtn.addEventListener("click", () => {
    ws.send(JSON.stringify({ type: "hangup" }));
    endCall();
  });

  async function ensurePeer() {
    if (pc) return;

    localStream = await navigator.mediaDevices.getUserMedia({
      video: true,
      audio: true
    });

    localVideo.srcObject = localStream;

    pc = new RTCPeerConnection({
      iceServers: [{ urls: "stun:stun.l.google.com:19302" }]
    });

    localStream.getTracks().forEach(track =>
      pc.addTrack(track, localStream)
    );

    pc.ontrack = (event) => {
      remoteVideo.srcObject = event.streams[0];
    };

    pc.onicecandidate = (event) => {
      if (event.candidate) {
        ws.send(JSON.stringify({
          type: "candidate",
          candidate: event.candidate
        }));
      }
    };
  }

  function endCall() {
    statusEl.textContent = "Esperando‚Ä¶";
    hangBtn.disabled = true;
    answerBtn.disabled = true;
    pendingOffer = null;

    if (pc) {
      pc.close();
      pc = null;
    }

    if (localStream) {
      localStream.getTracks().forEach(t => t.stop());
      localStream = null;
    }

    localVideo.srcObject = null;
    remoteVideo.srcObject = null;
  }
</script>

</body>
</html>
