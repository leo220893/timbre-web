<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Timbre ‚Äì Propietario</title>

  <!-- PWA -->
  <link rel="manifest" href="/manifest.webmanifest">
  <meta name="theme-color" content="#1f3a8a">

  <style>
    body { font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif; margin: 16px; background: #e8f1ff; }
    video { width: 100%; max-width: 360px; background: #000; border-radius: 12px; margin-top: 10px; }
    #status { display:inline-block; padding:8px 12px; background:#fff; border-radius:999px; margin-bottom: 10px; font-weight: 600; }
    button { padding: 12px 16px; font-size: 15px; border-radius: 10px; border: none; cursor: pointer; margin-right: 8px; margin-top: 6px; }
    #answerBtn { background: #22c55e; color: #fff; }
    #hangBtn { background: #ef4444; color: #fff; }
    #notifyBtn { background: #1f3a8a; color: #fff; }
  </style>
</head>
<body>

  <h2>üè† Timbre ‚Äì Familia VEGA // BALDOVINO</h2>

  <div id="status">Conectando‚Ä¶</div><br>

  <button id="answerBtn" disabled>‚úÖ Atender</button>
  <button id="hangBtn" disabled>‚õî Finalizar</button>
  <button id="notifyBtn">üîî Activar notificaciones (Push)</button>

  <h4>Tu c√°mara</h4>
  <video id="localVideo" autoplay muted playsinline></video>

  <h4>Visitante</h4>
  <video id="remoteVideo" autoplay playsinline></video>

<script>
  // ====== PWA: registrar Service Worker ======
  if ("serviceWorker" in navigator) {
    navigator.serviceWorker.register("/sw.js").catch(() => {});
  }

  // ====== Config ======
  const roomId = new URLSearchParams(window.location.search).get("room") || "FLIA.VEGA-BALDOVINO";

  const statusEl = document.getElementById("status");
  const answerBtn = document.getElementById("answerBtn");
  const hangBtn = document.getElementById("hangBtn");
  const notifyBtn = document.getElementById("notifyBtn");
  const localVideo = document.getElementById("localVideo");
  const remoteVideo = document.getElementById("remoteVideo");

  let pc = null;
  let localStream = null;
  let pendingOffer = null;

  const wsProtocol = location.protocol === "https:" ? "wss://" : "ws://";
  const ws = new WebSocket(wsProtocol + location.host);

  // ====== Timbre fuerte y repetitivo ======
  let ringTimer = null;
  function playRing() {
    try {
      const ctx = new (window.AudioContext || window.webkitAudioContext)();
      const now = ctx.currentTime;

      function tone(freq, start, dur, vol) {
        const o = ctx.createOscillator();
        const g = ctx.createGain();
        o.frequency.value = freq;
        o.type = "triangle";
        g.gain.setValueAtTime(0.001, start);
        g.gain.exponentialRampToValueAtTime(vol, start + 0.02);
        g.gain.exponentialRampToValueAtTime(0.001, start + dur);
        o.connect(g); g.connect(ctx.destination);
        o.start(start); o.stop(start + dur);
      }

      tone(1200, now, 0.4, 0.8);
      tone(700, now + 0.45, 0.6, 0.8);

      setTimeout(() => ctx.close().catch(() => {}), 1200);
    } catch {}
  }

  function startRinging() {
    if (ringTimer) return;
    playRing();
    ringTimer = setInterval(playRing, 2200);
  }

  function stopRinging() {
    if (ringTimer) clearInterval(ringTimer);
    ringTimer = null;
  }

  // ====== PUSH: helpers ======
  function urlBase64ToUint8Array(base64String) {
    const padding = "=".repeat((4 - (base64String.length % 4)) % 4);
    const base64 = (base64String + padding).replace(/-/g, "+").replace(/_/g, "/");
    const rawData = atob(base64);
    const outputArray = new Uint8Array(rawData.length);
    for (let i = 0; i < rawData.length; ++i) outputArray[i] = rawData.charCodeAt(i);
    return outputArray;
  }

  async function ensurePushSubscription() {
    if (!("serviceWorker" in navigator) || !("PushManager" in window)) {
      throw new Error("Push no soportado en este navegador.");
    }

    // Esperar SW listo
    const reg = await navigator.serviceWorker.ready;

    // Public key desde server
    const r = await fetch("/api/push/public-key");
    const { publicKey } = await r.json();
    if (!publicKey) throw new Error("No hay VAPID public key configurada.");

    // Pedir permiso notificaciones
    const perm = await Notification.requestPermission();
    if (perm !== "granted") throw new Error("Permiso de notificaciones denegado.");

    // Suscribir o reutilizar
    let sub = await reg.pushManager.getSubscription();
    if (!sub) {
      sub = await reg.pushManager.subscribe({
        userVisibleOnly: true,
        applicationServerKey: urlBase64ToUint8Array(publicKey)
      });
    }

    // Enviar al server para esta room
    const save = await fetch("/api/push/subscribe", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ roomId, subscription: sub })
    });

    if (!save.ok) throw new Error("No se pudo guardar la suscripci√≥n.");
  }

  // Bot√≥n: activar PUSH real
  notifyBtn.onclick = async () => {
    try {
      await ensurePushSubscription();
      alert("‚úÖ Push activado. Te va a llegar una notificaci√≥n en la barra cuando toquen el timbre.");
    } catch (e) {
      alert("‚ùå No se pudo activar Push: " + (e?.message || "error"));
    }
  };

  // ====== WebSocket ======
  ws.onopen = () => {
    ws.send(JSON.stringify({ type: "join", roomId, role: "owner" }));
    statusEl.textContent = "Esperando‚Ä¶";
  };

  ws.onmessage = async (event) => {
    const msg = JSON.parse(event.data);

    if (msg.type === "peer-joined") {
      statusEl.textContent = "Alguien est√° tocando el timbre‚Ä¶";
      startRinging();
    }

    if (msg.type === "offer") {
      pendingOffer = msg.offer;
      answerBtn.disabled = false;
      statusEl.textContent = "Llamada entrante";
      startRinging();
    }

    if (msg.type === "candidate" && pc) {
      try { await pc.addIceCandidate(msg.candidate); } catch {}
    }

    if (msg.type === "hangup" || msg.type === "peer-left") {
      endCall();
    }
  };

  // ====== Atender ======
  answerBtn.onclick = async () => {
    if (!pendingOffer) return;

    stopRinging();
    answerBtn.disabled = true;
    statusEl.textContent = "Conectando‚Ä¶";

    await ensurePeer();
    await pc.setRemoteDescription(pendingOffer);

    const answer = await pc.createAnswer();
    await pc.setLocalDescription(answer);

    ws.send(JSON.stringify({ type: "answer", answer }));

    pendingOffer = null;
    hangBtn.disabled = false;
    statusEl.textContent = "En llamada";
  };

  // ====== Finalizar ======
  hangBtn.onclick = () => {
    ws.send(JSON.stringify({ type: "hangup" }));
    endCall();
  };

  async function ensurePeer() {
    if (pc) return;

    localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
    localVideo.srcObject = localStream;

    pc = new RTCPeerConnection({
      iceServers: [{ urls: "stun:stun.l.google.com:19302" }]
    });

    localStream.getTracks().forEach(t => pc.addTrack(t, localStream));

    pc.ontrack = e => remoteVideo.srcObject = e.streams[0];
    pc.onicecandidate = e => {
      if (e.candidate) {
        ws.send(JSON.stringify({ type: "candidate", candidate: e.candidate }));
      }
    };
  }

  function endCall() {
    stopRinging();
    statusEl.textContent = "Esperando‚Ä¶";
    answerBtn.disabled = true;
    hangBtn.disabled = true;
    pendingOffer = null;

    if (pc) { pc.close(); pc = null; }
    if (localStream) {
      localStream.getTracks().forEach(t => t.stop());
      localStream = null;
    }

    localVideo.srcObject = null;
    remoteVideo.srcObject = null;
  }
</script>

</body>
</html>
